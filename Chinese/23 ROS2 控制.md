### **ä»€ä¹ˆæ˜¯ `ros2_control`ï¼Ÿ**

`ros2_control` æ˜¯ ROS 2 ä¸­çš„ä¸€ä¸ªæ¨¡å—åŒ–æ¡†æ¶ï¼Œ<u>ç”¨äºå®ç°**ç¡¬ä»¶æ¥å£æŠ½è±¡**å’Œ**æœºå™¨äººæ§åˆ¶ç³»ç»Ÿ**ã€‚</u>å®ƒä¸ºå¼€å‘è€…æä¾›äº†ä¸€ç§æ ‡å‡†åŒ–çš„æ–¹æ³•æ¥é›†æˆæœºå™¨äººç¡¬ä»¶ï¼ˆå¦‚ç”µæœºã€ä¼ æ„Ÿå™¨ï¼‰ä¸é«˜å±‚æ§åˆ¶ç®—æ³•ï¼ˆå¦‚è·¯å¾„è§„åˆ’ã€è¿åŠ¨æ§åˆ¶ï¼‰ã€‚

------

### **`ros2_control` çš„ä¸»è¦åŠŸèƒ½**

1. **ç¡¬ä»¶æŠ½è±¡å±‚ (Hardware Abstraction Layer)ï¼š**
   - å®šä¹‰å’Œç®¡ç†æœºå™¨äººç¡¬ä»¶èµ„æºï¼ˆå¦‚å…³èŠ‚ã€ä¼ æ„Ÿå™¨ã€æ‰§è¡Œå™¨ï¼‰ã€‚
   - ä¸ºæœºå™¨äººç¡¬ä»¶ä¸ ROS 2 è½¯ä»¶æ ˆä¹‹é—´æä¾›ç»Ÿä¸€çš„æ¥å£ã€‚
2. **æ§åˆ¶å™¨ç®¡ç† (Controller Manager)ï¼š**
   - è´Ÿè´£åŠ è½½ã€å¯åŠ¨ã€åœæ­¢å’Œåˆ‡æ¢æ§åˆ¶å™¨ã€‚
   - å…è®¸åŠ¨æ€åŠ è½½æ§åˆ¶å™¨ä»¥é€‚åº”ä¸åŒçš„ä»»åŠ¡éœ€æ±‚ã€‚
3. **å®æ—¶æ§åˆ¶æ”¯æŒï¼š**
   - æä¾›é«˜æ€§èƒ½å’Œå®æ—¶èƒ½åŠ›çš„æ§åˆ¶å™¨è¿è¡Œç¯å¢ƒã€‚
   - æ”¯æŒå‘¨æœŸæ€§æ§åˆ¶å›è·¯ï¼ˆå¦‚ 1 kHz çš„æ§åˆ¶é¢‘ç‡ï¼‰ã€‚
4. **å¤šç§æ§åˆ¶å™¨æ’ä»¶æ”¯æŒï¼š**
   - æ”¯æŒæ ‡å‡†æ§åˆ¶å™¨ï¼ˆå¦‚ä½ç½®æ§åˆ¶ã€é€Ÿåº¦æ§åˆ¶ã€åŠ›/æ‰­çŸ©æ§åˆ¶ï¼‰ã€‚
   - æ”¯æŒç”¨æˆ·è‡ªå®šä¹‰æ§åˆ¶å™¨ã€‚

------

### **`ros2_control` æ¡†æ¶çš„ä¸»è¦ç»„æˆéƒ¨åˆ†**

#### **1. Hardware Interface (ç¡¬ä»¶æ¥å£)**

- æè¿°å’Œå®ç°ä¸æœºå™¨äººç¡¬ä»¶ï¼ˆå¦‚ç”µæœºã€ä¼ æ„Ÿå™¨ï¼‰çš„äº¤äº’ã€‚
- å°†æœºå™¨äººç‰©ç†ç¡¬ä»¶æŠ½è±¡ä¸ºæ ‡å‡†æ¥å£ï¼Œå¦‚å…³èŠ‚ä½ç½®ã€é€Ÿåº¦ã€æ‰­çŸ©ç­‰ã€‚
- ç¤ºä¾‹ï¼š
  - <u>**å‡è®¾æœºå™¨äººæœ‰ 6 ä¸ªå…³èŠ‚ï¼Œæ¯ä¸ªå…³èŠ‚éƒ½éœ€è¦æ§åˆ¶ä½ç½®ï¼Œåˆ™ `ros2_control` ä¼šæä¾›ä¸€ä¸ªå…³èŠ‚æ¥å£ï¼Œå¼€å‘è€…åªéœ€å®ç°è¯»å–å’Œå†™å…¥è¿™äº›å…³èŠ‚çŠ¶æ€çš„æ–¹æ³•ã€‚**</u>

#### **2. Controller (æ§åˆ¶å™¨)**

- å®ç°ç‰¹å®šçš„æ§åˆ¶é€»è¾‘ï¼Œä¾‹å¦‚ï¼š
  - <u>**JointTrajectoryController**ï¼šç”¨äºå…³èŠ‚çš„è½¨è¿¹è·Ÿè¸ªã€‚</u>
  - **<u>DiffDriveController**ï¼šç”¨äºå·®é€Ÿé©±åŠ¨æœºå™¨äººçš„é€Ÿåº¦æ§åˆ¶</u>ã€‚
  - **ForceTorqueSensorController**ï¼šç”¨äºè¯»å–åŠ›/æ‰­çŸ©ä¼ æ„Ÿå™¨çš„æ•°æ®ã€‚
- æ§åˆ¶å™¨é€šè¿‡è¯é¢˜æˆ–æœåŠ¡ä¸å¤–éƒ¨ç»„ä»¶ï¼ˆå¦‚å¯¼èˆªç³»ç»Ÿæˆ–è§„åˆ’ç®—æ³•ï¼‰é€šä¿¡ã€‚

#### **3. Controller Manager**

- è´Ÿè´£ç®¡ç†å’Œåè°ƒæ‰€æœ‰åŠ è½½çš„æ§åˆ¶å™¨ã€‚
- æä¾›æ¥å£ç”¨äºåŠ è½½ã€åˆ‡æ¢å’Œåœæ­¢æ§åˆ¶å™¨ã€‚

------

### **`ros2_control` çš„å·¥ä½œæµç¨‹**

1. **ç¡¬ä»¶æŠ½è±¡å±‚å®ç°ï¼š**
   - å®šä¹‰ç¡¬ä»¶æ¥å£ï¼ˆå¦‚ç”µæœºé©±åŠ¨ã€ä¼ æ„Ÿå™¨æ•°æ®è¯»å–ï¼‰ã€‚
   - ç¼–å†™ä¸€ä¸ªè‡ªå®šä¹‰çš„ç¡¬ä»¶æ¥å£æ’ä»¶ï¼Œç»§æ‰¿è‡ª `ros2_control` æä¾›çš„ `hardware_interface::SystemInterface`ã€‚
2. **é…ç½®ç¡¬ä»¶æè¿°æ–‡ä»¶ï¼š**
   - ä½¿ç”¨ `URDF` æˆ– `xacro` æ–‡ä»¶æè¿°æœºå™¨äººæ¨¡å‹ï¼ŒåŒ…æ‹¬å…³èŠ‚ã€æ‰§è¡Œå™¨ã€ä¼ æ„Ÿå™¨ã€‚
   - åœ¨ URDF ä¸­æ·»åŠ  `ros2_control` æ ‡ç­¾ï¼Œå®šä¹‰ç¡¬ä»¶æ¥å£å’Œæ§åˆ¶å™¨ç±»å‹ã€‚
3. **å¯åŠ¨æ§åˆ¶å™¨ï¼š**
   - å¯åŠ¨ `controller_manager`ï¼ŒåŠ è½½æ‰€éœ€æ§åˆ¶å™¨ï¼ˆå¦‚é€Ÿåº¦æ§åˆ¶å™¨æˆ–è½¨è¿¹æ§åˆ¶å™¨ï¼‰ã€‚
   - æ§åˆ¶å™¨é€šè¿‡è¯é¢˜æˆ–æœåŠ¡æ¥æ”¶æŒ‡ä»¤å¹¶è°ƒç”¨ç¡¬ä»¶æ¥å£ã€‚
4. **è¿è¡Œæ§åˆ¶å›è·¯ï¼š**
   - æ§åˆ¶å™¨å‘¨æœŸæ€§åœ°è·å–ä¼ æ„Ÿå™¨çŠ¶æ€ï¼Œå¹¶æ ¹æ®æ§åˆ¶é€»è¾‘ç”ŸæˆæŒ‡ä»¤ï¼ˆå¦‚é€Ÿåº¦æˆ–ä½ç½®ï¼‰ã€‚
   - ç¡¬ä»¶æ¥å£æ¥æ”¶æŒ‡ä»¤å¹¶å°†å…¶å‘é€åˆ°å®é™…ç¡¬ä»¶æ‰§è¡Œã€‚

------



### **å¦‚ä½•åœ¨æœºå™¨äººä¸­ä½¿ç”¨ `ros2_control`**

#### **1. åˆ›å»ºç¡¬ä»¶æ¥å£**

ç¡¬ä»¶æ¥å£è´Ÿè´£ä¸æœºå™¨äººç¡¬ä»¶äº¤äº’ã€‚å¼€å‘è€…éœ€è¦å®ç°ä»¥ä¸‹å…³é”®æ–¹æ³•ï¼š

- **`on_init()`**ï¼šåˆå§‹åŒ–ç¡¬ä»¶æ¥å£ã€‚
- **`read()`**ï¼šä»ç¡¬ä»¶ä¸­è¯»å–ä¼ æ„Ÿå™¨æ•°æ®ï¼ˆå¦‚å…³èŠ‚ä½ç½®ï¼‰ã€‚
- **`write()`**ï¼šå‘ç¡¬ä»¶å‘é€æ§åˆ¶æŒ‡ä»¤ï¼ˆå¦‚ç”µæœºç›®æ ‡é€Ÿåº¦ï¼‰ã€‚

**ç¤ºä¾‹ä»£ç ï¼š**

```cpp
#include <hardware_interface/system_interface.hpp>
#include <hardware_interface/types/hardware_interface_return_values.hpp>

class MyRobotHardware : public hardware_interface::SystemInterface {
public:
    hardware_interface::CallbackReturn on_init(const hardware_interface::HardwareInfo &info) override {
        // åˆå§‹åŒ–ç¡¬ä»¶ï¼ˆä¾‹å¦‚è¿æ¥ç”µæœºé©±åŠ¨ï¼‰
        return hardware_interface::CallbackReturn::SUCCESS;
    }

    hardware_interface::return_type read(const rclcpp::Time &time, const rclcpp::Duration &period) override {
        // ä»ç¡¬ä»¶è¯»å–å…³èŠ‚çŠ¶æ€
        joint_positions_[0] = ... // è¯»å–å…³èŠ‚ 1 çš„ä½ç½®
        return hardware_interface::return_type::OK;
    }

    hardware_interface::return_type write(const rclcpp::Time &time, const rclcpp::Duration &period) override {
        // å°†æ§åˆ¶æŒ‡ä»¤å†™å…¥ç¡¬ä»¶
        send_motor_command(joint_commands_[0]); // å‘é€å…³èŠ‚ 1 çš„ç›®æ ‡ä½ç½®
        return hardware_interface::return_type::OK;
    }
};
```

#### **2. é…ç½®æœºå™¨äººæè¿°æ–‡ä»¶ï¼ˆURDF/Xacroï¼‰**

åœ¨ URDF æ–‡ä»¶ä¸­æ·»åŠ  `ros2_control` é…ç½®ã€‚ä¾‹å¦‚ï¼š

```xml
<robot name="my_robot">
  <ros2_control name="MyRobotHardware" type="system">
    <hardware>
      <plugin>my_robot_control/MyRobotHardware</plugin>
    </hardware>
    <joint name="joint1">
      <command_interface name="position"/>
      <state_interface name="position"/>
    </joint>
  </ros2_control>
</robot>
```

- **`plugin`ï¼š** æŒ‡å®šç¡¬ä»¶æ¥å£çš„æ’ä»¶åç§°ã€‚
- **`command_interface` å’Œ `state_interface`ï¼š** å®šä¹‰å…³èŠ‚çš„æ§åˆ¶å’ŒçŠ¶æ€ç±»å‹ï¼ˆå¦‚ä½ç½®ã€é€Ÿåº¦ã€æ‰­çŸ©ï¼‰ã€‚

#### **3. å¯åŠ¨ `ros2_control`**

å¯åŠ¨ `controller_manager` å¹¶åŠ è½½æ§åˆ¶å™¨ã€‚ä¾‹å¦‚ï¼š

```bash
ros2 launch my_robot_bringup my_robot_control.launch.py
```

å¯åŠ¨æ–‡ä»¶å¯èƒ½åŒ…å«ï¼š

- `controller_manager` çš„èŠ‚ç‚¹ã€‚
- ç¡¬ä»¶æ¥å£çš„åŠ è½½é…ç½®ã€‚
- æ§åˆ¶å™¨çš„å¯åŠ¨å‘½ä»¤ã€‚

#### **4. åŠ è½½å’Œè¿è¡Œæ§åˆ¶å™¨**

ä½¿ç”¨ ROS 2 æœåŠ¡æˆ–å‘½ä»¤è¡ŒåŠ è½½æ§åˆ¶å™¨ï¼š

```bash
# åŠ è½½æ§åˆ¶å™¨
ros2 control load_controller joint_trajectory_controller

# å¯åŠ¨æ§åˆ¶å™¨
ros2 control set_controller_state joint_trajectory_controller start
```

------

### **`ros2_control` çš„å®é™…åº”ç”¨åœºæ™¯**

1. **æœºæ¢°è‡‚ï¼š**
   - ä½¿ç”¨ `JointTrajectoryController` æ§åˆ¶æœºæ¢°è‡‚è½¨è¿¹ã€‚
   - é›†æˆåŠ›/æ‰­çŸ©ä¼ æ„Ÿå™¨è¿›è¡Œç²¾ç¡®æ“ä½œã€‚
2. **ç§»åŠ¨æœºå™¨äººï¼š**
   - ä½¿ç”¨ `DiffDriveController` æ§åˆ¶å·®é€Ÿé©±åŠ¨åº•ç›˜çš„é€Ÿåº¦ã€‚
   - ç»“åˆå¯¼èˆªæ ˆå®ç°ç›®æ ‡ç‚¹å¯¼èˆªã€‚
3. **å››è¶³æœºå™¨äººï¼š**
   - é€šè¿‡è‡ªå®šä¹‰æ§åˆ¶å™¨å®ç°å¤æ‚çš„è¿åŠ¨æ¨¡å¼ï¼ˆå¦‚æ­¥æ€åˆ‡æ¢ï¼‰ã€‚
   - ä½¿ç”¨ `ros2_control` ç®¡ç†å¤šä¸ªæ‰§è¡Œå™¨å’Œä¼ æ„Ÿå™¨ã€‚

------

### **æ€»ç»“**

`ros2_control` æ˜¯ ROS 2 ä¸­å®ç°æœºå™¨äººç¡¬ä»¶æŠ½è±¡å’Œæ§åˆ¶çš„æ ¸å¿ƒå·¥å…·ã€‚å®ƒé€šè¿‡æä¾›ç»Ÿä¸€çš„ç¡¬ä»¶æ¥å£ã€çµæ´»çš„æ§åˆ¶å™¨ç®¡ç†ä»¥åŠå®æ—¶æ§åˆ¶èƒ½åŠ›ï¼Œä½¿æœºå™¨äººå¼€å‘æ›´åŠ æ¨¡å—åŒ–å’Œé«˜æ•ˆã€‚

- **æ ¸å¿ƒåŠŸèƒ½ï¼š** ç¡¬ä»¶æŠ½è±¡ã€æ§åˆ¶å™¨ç®¡ç†ã€å®æ—¶æ§åˆ¶ã€‚
- **ä¸»è¦ç»„ä»¶ï¼š** ç¡¬ä»¶æ¥å£ã€æ§åˆ¶å™¨ã€æ§åˆ¶å™¨ç®¡ç†å™¨ã€‚
- **ä½¿ç”¨åœºæ™¯ï¼š** é€‚ç”¨äºæœºæ¢°è‡‚ã€ç§»åŠ¨æœºå™¨äººã€æ— äººæœºç­‰å¤šç§æœºå™¨äººç³»ç»Ÿã€‚

é€šè¿‡ `ros2_control`ï¼Œå¼€å‘è€…å¯ä»¥å¿«é€Ÿæ„å»ºé«˜æ•ˆã€çµæ´»çš„æœºå™¨äººæ§åˆ¶ç³»ç»Ÿã€‚



# ä¾‹å­ï¼š**ä¸€ä¸ªç®€å•çš„ ROS 2 `ros2_control` æœºæ¢°è‡‚æ§åˆ¶æ¡ˆä¾‹** ğŸ±

ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€åŒ–çš„æ¡ˆä¾‹ï¼Œç”¨äºå¸®åŠ©ä½ ç†è§£å¦‚ä½•ä½¿ç”¨ `ros2_control` æ§åˆ¶ä¸€ä¸ªæœºæ¢°è‡‚ã€‚è¿™ä¸ªæ¡ˆä¾‹å‡è®¾ä½ çš„æœºæ¢°è‡‚æœ‰ä¸¤ä¸ªå…³èŠ‚ï¼ˆJoint 1 å’Œ Joint 2ï¼‰ï¼Œ**å¹¶ä½¿ç”¨ä½ç½®æ§åˆ¶ï¼ˆPosition Controlï¼‰ã€‚**

------

### **1. ç›®æ ‡**

å®ç°ä¸€ä¸ªç®€å•çš„æœºæ¢°è‡‚æ§åˆ¶ï¼Œé€šè¿‡ `ros2_control`:

1. åœ¨æ¨¡æ‹Ÿç¯å¢ƒä¸­æ§åˆ¶æœºæ¢°è‡‚çš„å…³èŠ‚è¿åŠ¨ã€‚
2. <u>ä½¿ç”¨ `JointStateController` å’Œ `JointTrajectoryController` æ¥å‘å¸ƒå…³èŠ‚çŠ¶æ€å¹¶å‘é€ç›®æ ‡ä½ç½®ã€‚</u>

------

### **2. æ–‡ä»¶ç»“æ„**

```plaintext
my_robot_control/
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ ros2_control_config.yaml   # ros2_control é…ç½®æ–‡ä»¶
â”œâ”€â”€ urdf/
â”‚   â”œâ”€â”€ my_robot.urdf.xacro        # æœºæ¢°è‡‚æè¿°æ–‡ä»¶
â”œâ”€â”€ launch/
â”‚   â”œâ”€â”€ bringup.launch.py          # å¯åŠ¨æ–‡ä»¶
```

------

### **3. æ­¥éª¤**

#### **3.1 ç¼–å†™ URDF æ–‡ä»¶**

æè¿°ä½ çš„æœºæ¢°è‡‚ï¼ŒåŒ…æ‹¬å…³èŠ‚ã€è¿æ†å’Œæ§åˆ¶æ¥å£ã€‚

åˆ›å»º `my_robot.urdf.xacro` æ–‡ä»¶ï¼š

```xml
<robot xmlns:xacro="http://www.ros.org/wiki/xacro" name="simple_arm">

  <!-- æœºæ¢°è‡‚åº•åº§ -->
  <link name="base_link"/>

  <!-- å…³èŠ‚1 -->
  <joint name="joint1" type="revolute">
    <parent link="base_link"/>
    <child link="link1"/>
    <origin xyz="0 0 0.1" rpy="0 0 0"/>
    <axis xyz="0 0 1"/>
    <limit effort="10" velocity="1.0" lower="-1.57" upper="1.57"/>
  </joint>
  <link name="link1"/>

  <!-- å…³èŠ‚2 -->
  <joint name="joint2" type="revolute">
    <parent link="link1"/>
    <child link="link2"/>
    <origin xyz="0.5 0 0" rpy="0 0 0"/>
    <axis xyz="0 0 1"/>
    <limit effort="10" velocity="1.0" lower="-1.57" upper="1.57"/>
  </joint>
  <link name="link2"/>

  <!-- ros2_control é…ç½® -->
  <ros2_control name="SimpleArmHardware" type="system">
    <hardware>
      <plugin>fake_components/GenericSystem</plugin>
    </hardware>
    <joint name="joint1">
      <command_interface name="position"/>
      <state_interface name="position"/>
      <state_interface name="velocity"/>
    </joint>
    <joint name="joint2">
      <command_interface name="position"/>
      <state_interface name="position"/>
      <state_interface name="velocity"/>
    </joint>
  </ros2_control>

</robot>
```

------

#### **3.2 ç¼–å†™ `ros2_control` é…ç½®æ–‡ä»¶**

åœ¨ `config/ros2_control_config.yaml` æ–‡ä»¶ä¸­å®šä¹‰æ§åˆ¶å™¨çš„é…ç½®ï¼š

```yaml
controller_manager:
  ros__parameters:
    update_rate: 50
    joint_state_broadcaster:
      type: joint_state_broadcaster/JointStateBroadcaster
      state_publish_rate: 50
    joint_trajectory_controller:
      type: joint_trajectory_controller/JointTrajectoryController
      joints:
        - joint1
        - joint2
      state_publish_rate: 50
      command_interfaces:
        - position
      trajectory_points_per_second: 50
      constraints:
        goal_time: 0.5
        stopped_velocity_tolerance: 0.01
      interpolator: position
```

------

#### **3.3 ç¼–å†™å¯åŠ¨æ–‡ä»¶**

åˆ›å»º `launch/bringup.launch.py` æ–‡ä»¶ï¼Œç”¨äºåŠ è½½ URDF å’Œå¯åŠ¨ `controller_manager`ï¼š

```python
from launch import LaunchDescription
from launch_ros.actions import Node

def generate_launch_description():
    return LaunchDescription([
        # åŠ è½½æœºæ¢°è‡‚çš„ URDF
        Node(
            package='robot_state_publisher',
            executable='robot_state_publisher',
            name='robot_state_publisher',
            output='screen',
            parameters=[{'robot_description': '/path/to/my_robot.urdf.xacro'}]
        ),
        # å¯åŠ¨ controller_manager
        Node(
            package='controller_manager',
            executable='ros2_control_node',
            parameters=['/path/to/config/ros2_control_config.yaml'],
            output='screen'
        ),
        # åŠ è½½å…³èŠ‚çŠ¶æ€å‘å¸ƒå™¨
        Node(
            package='controller_manager',
            executable='spawner',
            arguments=['joint_state_broadcaster'],
            output='screen'
        ),
        # åŠ è½½å…³èŠ‚è½¨è¿¹æ§åˆ¶å™¨
        Node(
            package='controller_manager',
            executable='spawner',
            arguments=['joint_trajectory_controller'],
            output='screen'
        )
    ])
```

------

#### **3.4 å¯åŠ¨æ¨¡æ‹Ÿæ§åˆ¶**

è¿è¡Œä»¥ä¸‹å‘½ä»¤å¯åŠ¨ç³»ç»Ÿï¼š

```bash
ros2 launch my_robot_control bringup.launch.py
```

------

#### **3.5 å‘é€æ§åˆ¶å‘½ä»¤**

é€šè¿‡ ROS 2 å‘å¸ƒå…³èŠ‚ç›®æ ‡è½¨è¿¹ï¼Œè®©æœºæ¢°è‡‚ç§»åŠ¨åˆ°æŒ‡å®šä½ç½®ã€‚

åˆ›å»ºä¸€ä¸ª YAML æ–‡ä»¶æè¿°ç›®æ ‡è½¨è¿¹ï¼Œä¾‹å¦‚ `trajectory.yaml`ï¼š

```yaml
trajectory:
  header:
    stamp: now
  joint_names:
    - joint1
    - joint2
  points:
    - positions: [0.5, 0.5]
      time_from_start: 2.0
    - positions: [-0.5, -0.5]
      time_from_start: 4.0
```

å‘å¸ƒè½¨è¿¹å‘½ä»¤ï¼š

```bash
ros2 topic pub /joint_trajectory_controller/joint_trajectory trajectory_msgs/msg/JointTrajectory \
  "{
    header: {stamp: {sec: 0, nanosec: 0}, frame_id: ''},
    joint_names: ['joint1', 'joint2'],
    points: [
      {positions: [0.5, 0.5], time_from_start: {sec: 2, nanosec: 0}},
      {positions: [-0.5, -0.5], time_from_start: {sec: 4, nanosec: 0}}
    ]
  }"
```

------

### **æ€»ç»“**

- **URDF æ–‡ä»¶ï¼š** æè¿°äº†æœºæ¢°è‡‚çš„ç‰©ç†ç»“æ„å’Œç¡¬ä»¶æ¥å£ã€‚
- **æ§åˆ¶å™¨ï¼š** ä½¿ç”¨ `joint_state_broadcaster` å‘å¸ƒå…³èŠ‚çŠ¶æ€ï¼Œä½¿ç”¨ `joint_trajectory_controller` æ§åˆ¶å…³èŠ‚è¿åŠ¨ã€‚
- **å‘å¸ƒè½¨è¿¹ï¼š** é€šè¿‡è¯é¢˜ `/joint_trajectory_controller/joint_trajectory` å‘é€ç›®æ ‡è½¨è¿¹ã€‚

è¿™æ˜¯ä¸€ä¸ªæœ€å°å¯è¿è¡Œçš„ä¾‹å­ï¼Œé€‚ç”¨äºç†è§£å¦‚ä½•ä½¿ç”¨ `ros2_control` æ§åˆ¶ä¸€ä¸ªç®€å•æœºæ¢°è‡‚ã€‚å¦‚æœéœ€è¦æ‰©å±•ï¼Œå¯ä»¥åœ¨ç¡¬ä»¶æ¥å£ä¸­æ›¿æ¢ `fake_components` ä¸ºå®é™…çš„ç¡¬ä»¶é©±åŠ¨ä»£ç ã€‚





# ä¾‹å­2ï¼šå¦‚ä½•ä½¿ç”¨ `DiffDriveController` æ§åˆ¶å·®é€Ÿé©±åŠ¨æœºå™¨äºº ğŸ¶

`DiffDriveController` æ˜¯ `ros2_control` æä¾›çš„ä¸€ä¸ªæ§åˆ¶å™¨æ’ä»¶ï¼Œç”¨äºæ§åˆ¶**å·®é€Ÿé©±åŠ¨æœºå™¨äººï¼ˆå¦‚å°è½¦åº•ç›˜**ï¼‰ã€‚é€šè¿‡æ¥æ”¶çº¿é€Ÿåº¦å’Œè§’é€Ÿåº¦å‘½ä»¤ï¼Œè¯¥æ§åˆ¶å™¨è®¡ç®—å·¦å³è½®çš„ç›®æ ‡é€Ÿåº¦å¹¶å‘ç¡¬ä»¶å‘é€æŒ‡ä»¤ã€‚

ä»¥ä¸‹æ˜¯å¦‚ä½•ä½¿ç”¨ `DiffDriveController` çš„è¯¦ç»†æ­¥éª¤ï¼š

------

### **1. åŸºç¡€æ¦‚å¿µ**

- å·®é€Ÿé©±åŠ¨æ¨¡å‹ï¼š
  - æœºå™¨äººé€šè¿‡ä¸¤ä¸ªç‹¬ç«‹çš„é©±åŠ¨è½®å®ç°å‰è¿›ã€åé€€å’Œè½¬å¼¯ã€‚
  - æ§åˆ¶è¾“å…¥ï¼š
    - çº¿é€Ÿåº¦ (`v`)ï¼šæ§åˆ¶å‰è¿›/åé€€çš„é€Ÿåº¦ã€‚
    - è§’é€Ÿåº¦ (`Ï‰`)ï¼šæ§åˆ¶æœºå™¨äººæ—‹è½¬çš„é€Ÿåº¦ã€‚
  - è¾“å‡ºåˆ°ç¡¬ä»¶ï¼š
    - å·¦è½®é€Ÿåº¦ (`v_left`) å’Œå³è½®é€Ÿåº¦ (`v_right`)ï¼Œç”±æ§åˆ¶å™¨è®¡ç®—å¾—å‡ºï¼š vleft=vâˆ’Ï‰â‹…b2,vright=v+Ï‰â‹…b2v_{\text{left}} = v - \frac{\omega \cdot b}{2}, \quad v_{\text{right}} = v + \frac{\omega \cdot b}{2} å…¶ä¸­ bb ä¸ºè½®é—´è·ã€‚

------

### **2. é…ç½® `DiffDriveController`**

#### **2.1 åˆ›å»ºæœºå™¨äººæè¿°æ–‡ä»¶ (URDF/Xacro)**

åœ¨ `my_robot.urdf.xacro` ä¸­å®šä¹‰æœºå™¨äººæ¨¡å‹å’Œç¡¬ä»¶æ¥å£ï¼š

```xml
<robot xmlns:xacro="http://www.ros.org/wiki/xacro" name="diff_drive_robot">

  <!-- åŸºç¡€é“¾æ¥ -->
  <link name="base_link"/>

  <!-- å·¦è½® -->
  <joint name="left_wheel_joint" type="continuous">
    <parent link="base_link"/>
    <child link="left_wheel"/>
    <origin xyz="0 0.1 0" rpy="0 0 0"/>
    <axis xyz="0 1 0"/>
  </joint>
  <link name="left_wheel"/>

  <!-- å³è½® -->
  <joint name="right_wheel_joint" type="continuous">
    <parent link="base_link"/>
    <child link="right_wheel"/>
    <origin xyz="0 -0.1 0" rpy="0 0 0"/>
    <axis xyz="0 1 0"/>
  </joint>
  <link name="right_wheel"/>

  <!-- ros2_control é…ç½® -->
  <ros2_control name="DiffDriveHardware" type="system">
    <hardware>
      <plugin>fake_components/GenericSystem</plugin>
    </hardware>
    <joint name="left_wheel_joint">
      <command_interface name="velocity"/>
      <state_interface name="velocity"/>
    </joint>
    <joint name="right_wheel_joint">
      <command_interface name="velocity"/>
      <state_interface name="velocity"/>
    </joint>
  </ros2_control>

</robot>
```

------

#### **2.2 é…ç½® `ros2_control` æ§åˆ¶å™¨**

åœ¨ `ros2_control_config.yaml` ä¸­æ·»åŠ  `DiffDriveController` çš„é…ç½®ï¼š

```yaml
controller_manager:
  ros__parameters:
    update_rate: 50
    diff_drive_controller:
      type: diff_drive_controller/DiffDriveController
      left_wheel_names:
        - left_wheel_joint
      right_wheel_names:
        - right_wheel_joint
      wheel_separation: 0.2               # ä¸¤è½®é—´è·ï¼ˆå•ä½ï¼šç±³ï¼‰
      wheel_radius: 0.05                  # è½®å­åŠå¾„ï¼ˆå•ä½ï¼šç±³ï¼‰
      cmd_vel_timeout: 0.25               # æ— å‘½ä»¤è¶…æ—¶æ—¶é—´ï¼ˆå•ä½ï¼šç§’ï¼‰
      publish_rate: 50                    # çŠ¶æ€å‘å¸ƒé¢‘ç‡
      velocity_commands_topic: /cmd_vel   # æ¥æ”¶é€Ÿåº¦å‘½ä»¤çš„è¯é¢˜
      use_stamped_vel: false              # æ˜¯å¦ä½¿ç”¨å¸¦æ—¶é—´æˆ³çš„å‘½ä»¤
```

------

### **3. å¯åŠ¨ `DiffDriveController`**

#### **3.1 åˆ›å»ºå¯åŠ¨æ–‡ä»¶**

åœ¨ `launch/diff_drive_bringup.launch.py` ä¸­åŠ è½½æœºå™¨äººæè¿°æ–‡ä»¶å’Œæ§åˆ¶å™¨ï¼š

```python
from launch import LaunchDescription
from launch_ros.actions import Node

def generate_launch_description():
    return LaunchDescription([
        # åŠ è½½ URDF
        Node(
            package='robot_state_publisher',
            executable='robot_state_publisher',
            parameters=[{'robot_description': '/path/to/my_robot.urdf.xacro'}],
        ),
        # å¯åŠ¨ controller_manager
        Node(
            package='controller_manager',
            executable='ros2_control_node',
            parameters=['/path/to/config/ros2_control_config.yaml'],
        ),
        # åŠ è½½ DiffDriveController
        Node(
            package='controller_manager',
            executable='spawner',
            arguments=['diff_drive_controller'],
        ),
    ])
```

#### **3.2 å¯åŠ¨ç³»ç»Ÿ**

è¿è¡Œå¯åŠ¨æ–‡ä»¶ï¼š

```bash
ros2 launch my_robot_control diff_drive_bringup.launch.py
```

------

### **4. æ§åˆ¶æœºå™¨äººç§»åŠ¨**

#### **4.1 å‘å¸ƒé€Ÿåº¦å‘½ä»¤**

ä½¿ç”¨ `cmd_vel` æ§åˆ¶æœºå™¨äººï¼š

```bash
ros2 topic pub /cmd_vel geometry_msgs/msg/Twist "linear:
  x: 0.5
  y: 0.0
  z: 0.0
angular:
  x: 0.0
  y: 0.0
  z: 0.5"
```

- **`linear.x`ï¼š** çº¿é€Ÿåº¦ï¼ˆå•ä½ï¼šç±³/ç§’ï¼‰ã€‚
- **`angular.z`ï¼š** è§’é€Ÿåº¦ï¼ˆå•ä½ï¼šå¼§åº¦/ç§’ï¼‰ã€‚

#### **4.2 æŸ¥çœ‹æ§åˆ¶å™¨çŠ¶æ€**

æ£€æŸ¥æ§åˆ¶å™¨æ˜¯å¦æ­£å¸¸è¿è¡Œï¼š

```bash
ros2 control list_controllers
```

åº”æ˜¾ç¤ºç±»ä¼¼ä»¥ä¸‹å†…å®¹ï¼š

```plaintext
diff_drive_controller[diff_drive_controller/DiffDriveController] active
```

------

### **5. è°ƒè¯•å’Œå¸¸è§é—®é¢˜**

#### **5.1 æœºå™¨äººä¸åŠ¨**

- æ£€æŸ¥æ˜¯å¦æ­£ç¡®åŠ è½½äº†æ§åˆ¶å™¨ï¼š

  ```bash
  ros2 control list_controllers
  ```

  ç¡®ä¿ 

  ```
  diff_drive_controller
  ```

   çŠ¶æ€ä¸º 

  ```
  active
  ```

  ã€‚

- æ£€æŸ¥æ˜¯å¦æ­£ç¡®å‘å¸ƒäº† 

  ```
  /cmd_vel
  ```

   å‘½ä»¤ï¼š

  ```bash
  ros2 topic echo /cmd_vel
  ```

#### **5.2 æœºå™¨äººè¿åŠ¨å¼‚å¸¸**

- ç¡®è®¤ `wheel_separation` å’Œ `wheel_radius` å‚æ•°æ˜¯å¦ä¸å®é™…ç¡¬ä»¶åŒ¹é…ã€‚
- ç¡®ä¿ URDF ä¸­çš„å…³èŠ‚é…ç½®æ­£ç¡®ï¼Œç‰¹åˆ«æ˜¯æ§åˆ¶æ¥å£å’ŒçŠ¶æ€æ¥å£ã€‚

#### **5.3 æ— æ³•æ¥æ”¶é€Ÿåº¦å‘½ä»¤**

- ç¡®è®¤ 

  ```
  /cmd_vel
  ```

   è¯é¢˜æ˜¯å¦å­˜åœ¨ï¼š

  ```bash
  ros2 topic list
  ```

------

### **6. æ€»ç»“**

- **URDF æ–‡ä»¶ï¼š** å®šä¹‰æœºå™¨äººæ¨¡å‹åŠå…¶å…³èŠ‚å’Œç¡¬ä»¶æ¥å£ã€‚
- **`ros2_control` é…ç½®ï¼š** ä½¿ç”¨ `DiffDriveController` æ§åˆ¶å·¦å³è½®é€Ÿåº¦ã€‚
- **å¯åŠ¨ç³»ç»Ÿï¼š** é€šè¿‡ `controller_manager` åŠ è½½æ§åˆ¶å™¨ã€‚
- **å‘é€é€Ÿåº¦å‘½ä»¤ï¼š** å‘å¸ƒ `/cmd_vel` å‘½ä»¤æ§åˆ¶æœºå™¨äººç§»åŠ¨ã€‚

é€šè¿‡ä¸Šè¿°é…ç½®ï¼Œä½ å¯ä»¥åœ¨ ROS 2 ä¸­æˆåŠŸä½¿ç”¨ `DiffDriveController` æ§åˆ¶å·®é€Ÿé©±åŠ¨æœºå™¨äººã€‚å¦‚æœéœ€è¦è¿æ¥çœŸå®ç¡¬ä»¶ï¼Œå¯ä»¥æ›¿æ¢ `GenericSystem` æ’ä»¶ä¸ºè‡ªå®šä¹‰ç¡¬ä»¶æ¥å£ï¼Œå®ç°ä¸åº•ç›˜ç”µæœºçš„é€šä¿¡ã€‚
